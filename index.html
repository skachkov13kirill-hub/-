<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#5B47B0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</title>
<style>
:root {
  --primary: #6C5CE7;
  --primary-dark: #5B47B0;
  --primary-light: #A29BFE;
  --accent: #00B894;
  --accent-red: #E17055;
  --accent-yellow: #FDCB6E;
  --bg: #F8F9FD;
  --card: #FFFFFF;
  --text: #2D3436;
  --text-secondary: #636E72;
  --border: #E8ECF1;
  --shadow: 0 2px 12px rgba(108,92,231,0.08);
  --radius: 14px;
  --nav-height: 64px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: calc(var(--nav-height) + 20px);
  -webkit-font-smoothing: antialiased;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.app-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 16px 20px 14px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(91,71,176,0.3);
}
.app-header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
.app-header .subtitle { font-size: 11px; opacity: 0.75; margin-top: 2px; }
.header-row { display: flex; justify-content: space-between; align-items: center; }
.header-sync {
  font-size: 10px; opacity: 0.6; background: rgba(255,255,255,0.15);
  padding: 3px 8px; border-radius: 8px; cursor: pointer;
}
.header-sync:hover { opacity: 0.9; }

/* ‚ïê‚ïê‚ïê BOTTOM NAVIGATION ‚ïê‚ïê‚ïê */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--nav-height);
  background: var(--card);
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid var(--border);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.06);
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom, 0);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 6px 16px;
  border-radius: 12px;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.nav-item .nav-icon { font-size: 22px; line-height: 1; }
.nav-item .nav-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); }
.nav-item.active { background: rgba(108,92,231,0.08); }
.nav-item.active .nav-icon { transform: scale(1.1); }
.nav-item.active .nav-label { color: var(--primary); font-weight: 700; }

/* ‚ïê‚ïê‚ïê MAIN TABS ‚ïê‚ïê‚ïê */
.main-tab { display: none; padding: 16px; animation: fadeIn 0.2s ease; }
.main-tab.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* ‚ïê‚ïê‚ïê SUB TABS ‚ïê‚ïê‚ïê */
.sub-tabs {
  display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto;
  -webkit-overflow-scrolling: touch; scrollbar-width: none;
  padding: 2px 0;
}
.sub-tabs::-webkit-scrollbar { display: none; }
.sub-tab {
  padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 20px;
  white-space: nowrap; cursor: pointer; border: none;
  background: var(--card); color: var(--text-secondary);
  box-shadow: var(--shadow); transition: all 0.2s;
}
.sub-tab.active {
  background: var(--primary); color: white;
  box-shadow: 0 4px 14px rgba(108,92,231,0.35);
}
.sub-content { display: none; animation: fadeIn 0.2s ease; }
.sub-content.active { display: block; }

/* ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê */
.card {
  background: var(--card); border-radius: var(--radius); padding: 18px;
  box-shadow: var(--shadow); margin-bottom: 14px;
}
.card-header { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text); }
.card-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white; border-radius: var(--radius); padding: 20px;
  box-shadow: 0 8px 24px rgba(108,92,231,0.25); margin-bottom: 14px;
}

/* ‚ïê‚ïê‚ïê STATS GRID ‚ïê‚ïê‚ïê */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
.stat-box {
  background: rgba(255,255,255,0.15); padding: 14px; border-radius: 12px; text-align: center;
}
.stat-box .stat-label { font-size: 11px; opacity: 0.8; margin-bottom: 4px; }
.stat-box .stat-value { font-size: 22px; font-weight: 800; }
.stat-box .stat-sub { font-size: 10px; opacity: 0.7; margin-top: 2px; }

/* ‚ïê‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê‚ïê */
.progress-wrap { background: rgba(255,255,255,0.2); border-radius: 10px; height: 26px; overflow: hidden; margin-top: 12px; }
.progress-fill {
  height: 100%; display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; transition: width 0.5s ease;
  background: linear-gradient(90deg, #00B894 0%, #55EFC4 100%);
}

/* ‚ïê‚ïê‚ïê FILIAL CARDS ‚ïê‚ïê‚ïê */
.filials-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
.filial-card { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
.filial-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
.filial-name { font-size: 14px; font-weight: 700; }
.filial-rank { font-size: 20px; font-weight: 800; color: var(--primary); }
.filial-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
.filial-row .label { color: var(--text-secondary); }
.filial-row .value { font-weight: 700; }
.filial-perf {
  text-align: center; padding: 8px; border-radius: 10px; font-weight: 700;
  font-size: 13px; margin-top: 10px;
}
.perf-high { background: #D4EDDA; color: #155724; }
.perf-med { background: #FFF3CD; color: #856404; }
.perf-low { background: #F8D7DA; color: #721C24; }

/* ‚ïê‚ïê‚ïê CREDIT CARDS ‚ïê‚ïê‚ïê */
.credit-card {
  background: var(--card); border-radius: var(--radius); padding: 14px;
  box-shadow: var(--shadow); margin-bottom: 10px;
  border-left: 4px solid var(--primary);
}
.credit-card.frozen { border-left-color: #B2BEC3; opacity: 0.6; }
.credit-top { display: flex; justify-content: space-between; align-items: baseline; }
.credit-name { font-size: 13px; font-weight: 700; }
.credit-rate { font-size: 12px; color: var(--accent-red); font-weight: 700; }
.credit-amount { font-size: 20px; font-weight: 800; margin: 6px 0; }
.credit-row { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
.credit-progress { height: 4px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.credit-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.4s; }

/* ‚ïê‚ïê‚ïê CALCULATOR ‚ïê‚ïê‚ïê */
.calc-big {
  text-align: center; padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white; border-radius: var(--radius); margin-bottom: 14px;
  box-shadow: 0 8px 24px rgba(108,92,231,0.3);
}
.calc-big .calc-label { font-size: 13px; opacity: 0.8; margin-bottom: 4px; }
.calc-big .calc-value { font-size: 36px; font-weight: 800; letter-spacing: -1px; }
.calc-big .calc-status { font-size: 14px; margin-top: 8px; }
.calc-breakdown .calc-row {
  display: flex; justify-content: space-between; padding: 10px 0;
  border-bottom: 1px solid var(--border); font-size: 13px;
}
.calc-breakdown .calc-row:last-child { border: none; }
.calc-row .positive { color: var(--accent); font-weight: 700; }
.calc-row .negative { color: var(--accent-red); font-weight: 700; }

/* ‚ïê‚ïê‚ïê MONTH SELECTOR ‚ïê‚ïê‚ïê */
.month-select-wrap {
  display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
  background: var(--card); padding: 10px 14px; border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.month-select-wrap label { font-size: 13px; font-weight: 600; }
.month-select-wrap select {
  flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 10px;
  font-size: 13px; font-weight: 600; background: var(--bg); cursor: pointer;
}
.btn-refresh {
  padding: 8px 14px; background: var(--primary); color: white; border: none;
  border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer;
}

/* ‚ïê‚ïê‚ïê LOADING / ERROR ‚ïê‚ïê‚ïê */
.loading-box { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
.spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top: 3px solid var(--primary);
  border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
@keyframes spin { to { transform: rotate(360deg); } }
.error-box { background: #FFF0F0; border-left: 4px solid var(--accent-red); padding: 14px; border-radius: 10px; color: #c0392b; font-size: 13px; margin: 10px 0; }

/* ‚ïê‚ïê‚ïê FAMILY IFRAME ‚ïê‚ïê‚ïê */
#tab-family { padding: 0; }
#tab-family.active { display: block; }

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast {
  position: fixed; top: 20px; right: 20px; z-index: 9999;
  background: var(--text); color: white; padding: 12px 20px;
  border-radius: 12px; font-size: 13px; font-weight: 600;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  transform: translateX(120%); transition: transform 0.3s ease;
}
.toast.show { transform: translateX(0); }

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media (max-width: 420px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .filials-grid { grid-template-columns: 1fr; }
  .stat-box .stat-value { font-size: 18px; }
  .calc-big .calc-value { font-size: 28px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- HEADER -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app-header">
  <div class="header-row">
    <div>
      <h1>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
      <div class="subtitle">–ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Ä¢ v1.0</div>
    </div>
    <div class="header-sync" onclick="loadAllData()" id="syncBadge">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB: –ë–ò–ó–ù–ï–° -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main-tab active" id="tab-business">
  
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSubTab('business', 'biz-overview', this)">üìä –û–±–∑–æ—Ä</button>
    <button class="sub-tab" onclick="switchSubTab('business', 'biz-filials', this)">üè™ –§–∏–ª–∏–∞–ª—ã</button>
    <button class="sub-tab" onclick="switchSubTab('business', 'biz-calendar', this)">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  </div>
  
  <!-- –û–±–∑–æ—Ä —Å–µ—Ç–∏ -->
  <div class="sub-content active" id="biz-overview">
    <div class="month-select-wrap">
      <label>–ú–µ—Å—è—Ü:</label>
      <select id="bizMonthSelect" onchange="loadBranches()">
        <option value="1">–Ø–Ω–≤–∞—Ä—å</option><option value="2">–§–µ–≤—Ä–∞–ª—å</option>
        <option value="3">–ú–∞—Ä—Ç</option><option value="4">–ê–ø—Ä–µ–ª—å</option>
        <option value="5">–ú–∞–π</option><option value="6">–ò—é–Ω—å</option>
        <option value="7">–ò—é–ª—å</option><option value="8">–ê–≤–≥—É—Å—Ç</option>
        <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option><option value="10">–û–∫—Ç—è–±—Ä—å</option>
        <option value="11">–ù–æ—è–±—Ä—å</option><option value="12">–î–µ–∫–∞–±—Ä—å</option>
      </select>
      <button class="btn-refresh" onclick="loadBranches()">üîÑ</button>
    </div>
    
    <div id="biz-loading" class="loading-box">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
    
    <div id="biz-overview-content" style="display:none;">
      <div class="card-gradient">
        <div style="text-align:center; font-size:16px; font-weight:700; margin-bottom:14px;">üè¢ –°–µ—Ç—å –∏–∑ 9 –∞—Ç–µ–ª—å–µ</div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">–ê—Ç–µ–ª—å–µ</div>
            <div class="stat-value" id="ov-atelie">‚Äî</div>
            <div class="stat-sub" id="ov-atelie-plan"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">–•–∏–º—á–∏—Å—Ç–∫–∞</div>
            <div class="stat-value" id="ov-himch">‚Äî</div>
            <div class="stat-sub" id="ov-himch-plan"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">–í—Å–µ–≥–æ</div>
            <div class="stat-value" id="ov-total">‚Äî</div>
            <div class="stat-sub" id="ov-total-plan"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="stat-value" id="ov-clients">‚Äî</div>
            <div class="stat-sub" id="ov-avg-check"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
            <div class="stat-value" id="ov-profit">‚Äî</div>
            <div class="stat-sub">—á–∏—Å—Ç–∞—è</div>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-fill" id="ov-progress" style="width:0%">0%</div>
        </div>
      </div>
    </div>
    
    <div id="biz-error" style="display:none;"></div>
  </div>
  
  <!-- –§–∏–ª–∏–∞–ª—ã -->
  <div class="sub-content" id="biz-filials">
    <div class="filials-grid" id="filialsGrid"></div>
  </div>
  
  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="sub-content" id="biz-calendar">
    <div class="card">
      <div class="card-header">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–æ–≤</div>
      <p style="font-size:13px; color:var(--text-secondary);">
        –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–æ–≤ –ø–æ—Ä—Ç–Ω—ã—Ö (9 —Ñ–∏–ª–∏–∞–ª–æ–≤ √ó –¥–Ω–∏ –º–µ—Å—è—Ü–∞).<br>
        üü¢ –æ—Ç—á—ë—Ç –ø–æ–ª—É—á–µ–Ω ‚Ä¢ üî¥ –Ω–µ—Ç –æ—Ç—á—ë—Ç–∞ ‚Ä¢ ‚ö™ –¥–µ–Ω—å –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª ‚Ä¢ üü° –æ–∂–∏–¥–∞–µ—Ç—Å—è<br><br>
        <em>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram –±–æ—Ç–∞ (–§–∞–∑–∞ 2+)</em>
      </p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB: –°–ï–ú–¨–Ø -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main-tab" id="tab-family">
  <iframe id="familyFrame" src="family.html?embedded=1" style="
    width: 100%;
    height: calc(100vh - var(--nav-height) - 8px);
    border: none;
    border-radius: var(--radius);
    background: #f3f4f6;
  "></iframe>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB: –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main-tab" id="tab-analytics">
  
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSubTab('analytics', 'an-calc', this)">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
    <button class="sub-tab" onclick="switchSubTab('analytics', 'an-credits', this)">üí≥ –ö—Ä–µ–¥–∏—Ç—ã</button>
  </div>
  
  <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
  <div class="sub-content active" id="an-calc">
    <div class="calc-big">
      <div class="calc-label">–°–≤–æ–±–æ–¥–Ω—ã—Ö –¥–µ–Ω–µ–≥</div>
      <div class="calc-value" id="calc-free">‚Äî</div>
      <div class="calc-status" id="calc-status"></div>
    </div>
    
    <div class="card">
      <div class="card-header">üìä –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è</div>
      <div class="calc-breakdown" id="calc-breakdown">
        <div class="calc-row">
          <span>–ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–æ–≤</span>
          <span class="positive" id="calc-balance">‚Äî</span>
        </div>
        <div class="calc-row">
          <span>+ –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–∞ (–æ—Å—Ç–∞—Ç–æ–∫ –º–µ—Å—è—Ü–∞)</span>
          <span class="positive" id="calc-income">‚Äî</span>
        </div>
        <div class="calc-row">
          <span>‚àí –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å–µ–º—å—é (–ø—Ä–æ–≥–Ω–æ–∑)</span>
          <span class="negative" id="calc-family">‚Äî</span>
        </div>
        <div class="calc-row">
          <span>‚àí –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–æ—Å—Ç–∞–≤—à–∏–µ—Å—è)</span>
          <span class="negative" id="calc-credits-pay">‚Äî</span>
        </div>
        <div class="calc-row">
          <span>‚àí –ê—Ä–µ–Ω–¥–∞</span>
          <span class="negative" id="calc-rent">‚Äî</span>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏</div>
      <div id="upcoming-payments">
        <div class="loading-box"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
      </div>
    </div>
  </div>
  
  <!-- –ö—Ä–µ–¥–∏—Ç—ã -->
  <div class="sub-content" id="an-credits">
    <!-- –û–±—â–∞—è —Å–≤–æ–¥–∫–∞ -->
    <div class="card-gradient" id="credits-summary">
      <div style="text-align:center; font-size:16px; font-weight:700; margin-bottom:12px;">üí≥ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">–û–±—â–∏–π –¥–æ–ª–≥</div>
          <div class="stat-value" id="cr-total-debt" style="font-size:18px;">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">–ü–ª–∞—Ç–µ–∂–∏ /–º–µ—Å</div>
          <div class="stat-value" id="cr-monthly-pay" style="font-size:18px;">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
          <div class="stat-value" id="cr-active-count">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">–ó–∞–∫—Ä—ã–≤–∞–µ–º –≤ 2026</div>
          <div class="stat-value" id="cr-close-count">‚Äî</div>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-fill" id="cr-progress" style="width:0%;">0%</div>
      </div>
      <div style="text-align:center; font-size:11px; opacity:0.7; margin-top:6px;" id="cr-progress-label"></div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤ -->
    <div id="credits-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- BOTTOM NAVIGATION -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="bottom-nav">
  <div class="nav-item active" onclick="switchMainTab('business', this)">
    <span class="nav-icon">üè¢</span>
    <span class="nav-label">–ë–∏–∑–Ω–µ—Å</span>
  </div>
  <div class="nav-item" onclick="switchMainTab('family', this)">
    <span class="nav-icon">üë®‚Äçüë©‚Äçüëß</span>
    <span class="nav-label">–°–µ–º—å—è</span>
  </div>
  <div class="nav-item" onclick="switchMainTab('analytics', this)">
    <span class="nav-icon">üìä</span>
    <span class="nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
  </div>
</nav>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –†–ï–ê–õ–¨–ù–´–ô URL –ù–û–í–û–ì–û APPS SCRIPT
const API_URL = 'https://script.google.com/macros/s/AKfycbxfN2eYhdWamLmTuR6I4unWFpNA4iOD5QxzaKWASZmW6G8El_FWk3vOi1wE7x4AUNasVA/exec';

// –°—Ç–∞—Ä—ã–π URL dashboard (fallback, –ø–æ–∫–∞ –Ω–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –Ω–æ–≤—ã–π)
const DASHBOARD_API_URL = 'https://script.google.com/macros/s/AKfycbwyjWBnlCZFMbjkcggsMQWuhaxUzNkxG2_QStfSqf3sSoeNlkF424ykPbrxgwtg2sA/exec';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let appState = {
  credits: [],
  settings: {},
  balances: [],
  forecast: [],
  branchData: null,
  currentBizMonth: new Date().getMonth() + 1,
  dataLoaded: false
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ù–ê–í–ò–ì–ê–¶–ò–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchMainTab(tabName, el) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('tab-' + tabName).classList.add('active');
  if (el) el.classList.add('active');
}

function switchSubTab(group, subId, el) {
  const parent = el.closest('.main-tab');
  parent.querySelectorAll('.sub-content').forEach(s => s.classList.remove('active'));
  parent.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(subId).classList.add('active');
  el.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadAllData() {
  showToast('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
  
  try {
    // –ü—Ä–æ–±—É–µ–º –Ω–æ–≤—ã–π API
    const res = await fetchWithTimeout(API_URL + '?action=getAll', 15000);
    const data = await res.json();
    
    if (data.success) {
      if (data.credits) appState.credits = data.credits;
      if (data.settings) appState.settings = data.settings;
      if (data.balances) appState.balances = data.balances;
      if (data.forecast) appState.forecast = data.forecast;
      appState.dataLoaded = true;
      
      renderCredits();
      renderCalculator();
      showToast('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    }
  } catch (err) {
    console.warn('New API not available, using defaults:', err.message);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    loadDefaults();
    renderCredits();
    renderCalculator();
    showToast('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à');
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã –æ—Ç–¥–µ–ª—å–Ω–æ (—á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π –∏–ª–∏ –Ω–æ–≤—ã–π API)
  loadBranches();
}

function loadDefaults() {
  appState.credits = [
    { name: '–¢-–ë–∞–Ω–∫ 27.3%', rate: 0.273, balanceInit: 1784581, balanceCurrent: 1784581, payment: 98650, paymentDay: 5, closeDate: '–ê–≤–≥ 2026', priority: 1, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–°–±–µ—Ä–±–∞–Ω–∫ 25.4%', rate: 0.254, balanceInit: 256000, balanceCurrent: 256000, payment: 2309, paymentDay: 10, closeDate: '', priority: 0, status: '‚ö†Ô∏è –ó–ê–ú–û–†–û–ñ–ï–ù' },
    { name: '–ö4 –§–∏–∑–ª–∏—Ü–æ', rate: 0.25, balanceInit: 397000, balanceCurrent: 397000, payment: 25000, paymentDay: 15, closeDate: '–°–µ–Ω 2026', priority: 3, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–ö3 –§–∏–∑–ª–∏—Ü–æ', rate: 0.25, balanceInit: 225000, balanceCurrent: 225000, payment: 20000, paymentDay: 0, closeDate: '–û–∫—Ç 2026', priority: 4, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–ö2 –§–∏–∑–ª–∏—Ü–æ', rate: 0.25, balanceInit: 474000, balanceCurrent: 474000, payment: 20000, paymentDay: 0, closeDate: '–û–∫—Ç 2026', priority: 5, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–ö1 –§–∏–∑–ª–∏—Ü–æ', rate: 0.20, balanceInit: 681417, balanceCurrent: 681417, payment: 15000, paymentDay: 0, closeDate: '–ù–æ—è 2026', priority: 6, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–°–±–µ—Ä–±–∞–Ω–∫ 19.5%', rate: 0.195, balanceInit: 483375, balanceCurrent: 483375, payment: 32700, paymentDay: 0, closeDate: '–î–µ–∫ 2026', priority: 7, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–°–±–µ—Ä–±–∞–Ω–∫ –ø–∞–ø–∞', rate: 0.1705, balanceInit: 831000, balanceCurrent: 831000, payment: 30300, paymentDay: 0, closeDate: '–î–µ–∫ 2026', priority: 8, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–ê–±—Å–æ–ª—é—Ç –ë–∞–Ω–∫', rate: 0.10, balanceInit: 3346902, balanceCurrent: 3346902, payment: 30250, paymentDay: 0, closeDate: '–ù–µ –≤ 2026', priority: 9, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–î—Ä–∞–π–≤ –ö–ª–∏–∫', rate: 0.049, balanceInit: 1535172, balanceCurrent: 1535172, payment: 33000, paymentDay: 0, closeDate: '–ù–µ –≤ 2026', priority: 10, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–ò–ø–æ—Ç–µ–∫–∞', rate: 0.001, balanceInit: 8931119, balanceCurrent: 8931119, payment: 28200, paymentDay: 0, closeDate: '–ù–µ –≤ 2026', priority: 11, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
    { name: '–†–∞—Å—Å—Ä–æ—á–∫–∞', rate: 0.0, balanceInit: 246800, balanceCurrent: 246800, payment: 61600, paymentDay: 0, closeDate: '–ê–ø—Ä 2026', priority: 12, status: '–ê–∫—Ç–∏–≤–Ω—ã–π' }
  ];
  
  appState.settings = {
    '–º–∞—Ä–∂–∞_–∞—Ç–µ–ª—å–µ': 0.5, '–º–∞—Ä–∂–∞_—Ö–∏–º—á–∏—Å—Ç–∫–∞': 0.4, '–∞—Ä–µ–Ω–¥–∞_–≤—Å–µ–≥–æ': 396000,
    '–∫—Ä–µ–¥–∏—Ç–Ω–∞—è_–ª–∏–Ω–∏—è': 100000, '—Ä–∞—Å—Ö–æ–¥—ã_—Å–µ–º—å—è': 300000, '–ø–æ—Ä–æ–≥_–∫—Ä—É–ø–Ω—ã—Ö': 40000
  };
  
  appState.forecast = [
    { month: 1, income: 510263, obligations: 402327 },
    { month: 2, income: 488051, obligations: 402327 },
    { month: 3, income: 916641, obligations: 402327 },
    { month: 4, income: 928138, obligations: 402327 },
    { month: 5, income: 941033, obligations: 341127 },
    { month: 6, income: 917548, obligations: 340727 },
    { month: 7, income: 674080, obligations: 340727 },
    { month: 8, income: 794772, obligations: 340727 },
    { month: 9, income: 798438, obligations: 242065 },
    { month: 10, income: 878332, obligations: 222598 },
    { month: 11, income: 908278, obligations: 178820 },
    { month: 12, income: 895996, obligations: 169385 }
  ];
  
  appState.dataLoaded = true;
}

async function loadBranches() {
  const month = document.getElementById('bizMonthSelect').value;
  
  document.getElementById('biz-loading').style.display = 'block';
  document.getElementById('biz-overview-content').style.display = 'none';
  document.getElementById('biz-error').style.display = 'none';
  
  try {
    // –ü—Ä–æ–±—É–µ–º –Ω–æ–≤—ã–π API, –ø–æ—Ç–æ–º —Å—Ç–∞—Ä—ã–π
    let url = API_URL + '?action=getBranches&month=' + month;
    let res;
    
    try {
      res = await fetchWithTimeout(url, 12000);
    } catch {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π dashboard API
      res = await fetchWithTimeout(DASHBOARD_API_URL + '?month=' + month, 12000);
    }
    
    const data = await res.json();
    
    if (data.error) throw new Error(data.error);
    
    appState.branchData = data;
    renderBizOverview(data);
    renderFilials(data);
    
    document.getElementById('biz-loading').style.display = 'none';
    document.getElementById('biz-overview-content').style.display = 'block';
    
  } catch (err) {
    document.getElementById('biz-loading').style.display = 'none';
    document.getElementById('biz-error').style.display = 'block';
    document.getElementById('biz-error').innerHTML = `<div class="error-box">‚ö†Ô∏è ${err.message}</div>`;
  }
}

async function fetchWithTimeout(url, timeout = 10000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  const response = await fetch(url, { signal: controller.signal });
  clearTimeout(id);
  return response;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ï–ù–î–ï–†: –ë–ò–ó–ù–ï–°
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderBizOverview(data) {
  const t = data.totals;
  
  document.getElementById('ov-atelie').textContent = fmt(t.fact.atelie);
  document.getElementById('ov-himch').textContent = fmt(t.fact.himchistka);
  document.getElementById('ov-total').textContent = fmt(t.fact.total);
  document.getElementById('ov-clients').textContent = t.fact.clients.toLocaleString('ru-RU');
  document.getElementById('ov-profit').textContent = fmt(t.fact.profit);
  
  if (t.plan.total > 0) {
    document.getElementById('ov-atelie-plan').textContent = `–ü–ª–∞–Ω: ${fmt(t.plan.atelie)} (${t.performance.atelie}%)`;
    document.getElementById('ov-himch-plan').textContent = `–ü–ª–∞–Ω: ${fmt(t.plan.himchistka)} (${t.performance.himchistka}%)`;
    document.getElementById('ov-total-plan').textContent = `–ü–ª–∞–Ω: ${fmt(t.plan.total)} (${t.performance.total}%)`;
  }
  if (t.fact.avgCheck) document.getElementById('ov-avg-check').textContent = `–°—Ä.—á–µ–∫: ${fmt(t.fact.avgCheck)}`;
  
  const pct = t.performance ? Math.min(t.performance.total, 100) : 0;
  document.getElementById('ov-progress').style.width = pct + '%';
  document.getElementById('ov-progress').textContent = (t.performance ? t.performance.total : 0) + '%';
}

function renderFilials(data) {
  const grid = document.getElementById('filialsGrid');
  grid.innerHTML = '';
  
  const sorted = [...data.filials].sort((a, b) => b.fact.total - a.fact.total);
  
  sorted.forEach((f, i) => {
    const rank = i + 1;
    const perf = f.performance.total;
    let perfClass = 'perf-low', perfEmoji = 'üî¥';
    if (perf >= 95) { perfClass = 'perf-high'; perfEmoji = 'üü¢'; }
    else if (perf >= 85) { perfClass = 'perf-med'; perfEmoji = 'üü°'; }
    
    let forecastHtml = '';
    if (f.forecast) {
      const pEmoji = f.forecast.probability === 'high' ? 'üü¢' : f.forecast.probability === 'medium' ? 'üü°' : 'üî¥';
      forecastHtml = `
        <div style="background:var(--bg); padding:10px; border-radius:10px; margin-top:10px; font-size:12px; border-left:3px solid var(--primary);">
          <strong>üéØ –ü—Ä–æ–≥–Ω–æ–∑:</strong> ${fmt(f.forecast.total)} ${pEmoji}
          <div style="font-size:10px; color:var(--text-secondary); margin-top:2px;">–î–Ω–µ–π –ø—Ä–æ—à–ª–æ: ${f.forecast.daysPassed} | –û—Å—Ç–∞–ª–æ—Å—å: ${f.forecast.daysLeft}</div>
        </div>`;
    }
    
    grid.innerHTML += `
      <div class="filial-card">
        <div class="filial-top">
          <div class="filial-name">${f.name}</div>
          <div class="filial-rank">#${rank}</div>
        </div>
        <div class="filial-row"><span class="label">–ê—Ç–µ–ª—å–µ:</span><span class="value">${fmt(f.fact.atelie)}</span></div>
        <div style="font-size:10px; color:var(--text-secondary); margin-bottom:6px;">–ü–ª–∞–Ω: ${fmt(f.plan.atelie)} (${f.performance.atelie}%)</div>
        <div class="filial-row"><span class="label">–•–∏–º—á–∏—Å—Ç–∫–∞:</span><span class="value">${fmt(f.fact.himchistka)}</span></div>
        <div style="font-size:10px; color:var(--text-secondary); margin-bottom:6px;">–ü–ª–∞–Ω: ${fmt(f.plan.himchistka)} (${f.performance.himchistka}%)</div>
        <div class="filial-row"><span class="label"><strong>–ò–¢–û–ì–û:</strong></span><span class="value"><strong>${fmt(f.fact.total)}</strong></span></div>
        <div class="filial-perf ${perfClass}">${perfEmoji} ${perf}% –æ—Ç –ø–ª–∞–Ω–∞</div>
        <div style="background:#E7F3FF; padding:8px; border-radius:8px; margin-top:8px; font-size:11px;">
          <div style="display:flex; justify-content:space-between;"><span>üë• –ö–ª–∏–µ–Ω—Ç—ã:</span><strong>${f.fact.clients}</strong></div>
          <div style="display:flex; justify-content:space-between;"><span>üí∞ –°—Ä.—á–µ–∫:</span><strong>${fmt(f.fact.avgCheck)}</strong></div>
          <div style="display:flex; justify-content:space-between;"><span>‚úÖ –ü—Ä–∏–±—ã–ª—å:</span><strong>${fmt(f.fact.profit)}</strong></div>
        </div>
        ${forecastHtml}
      </div>`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ï–ù–î–ï–†: –ö–†–ï–î–ò–¢–´
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCredits() {
  const credits = appState.credits;
  if (!credits.length) return;
  
  const active = credits.filter(c => c.status === '–ê–∫—Ç–∏–≤–Ω—ã–π');
  const totalDebt = active.reduce((s, c) => s + (c.balanceCurrent || c.balanceInit), 0);
  const monthlyPay = active.reduce((s, c) => s + c.payment, 0);
  const closingIn2026 = credits.filter(c => c.closeDate && !c.closeDate.includes('–ù–µ –≤') && c.status === '–ê–∫—Ç–∏–≤–Ω—ã–π').length;
  const initialDebt = 19192366; // –Ø–Ω–≤–∞—Ä—å 2026
  
  document.getElementById('cr-total-debt').textContent = fmtShort(totalDebt);
  document.getElementById('cr-monthly-pay').textContent = fmtShort(monthlyPay);
  document.getElementById('cr-active-count').textContent = active.length;
  document.getElementById('cr-close-count').textContent = closingIn2026;
  
  const paidPct = Math.round((1 - totalDebt / initialDebt) * 100);
  document.getElementById('cr-progress').style.width = Math.max(paidPct, 0) + '%';
  document.getElementById('cr-progress').textContent = paidPct + '%';
  document.getElementById('cr-progress-label').textContent = `–ü–æ–≥–∞—à–µ–Ω–æ ${fmtShort(initialDebt - totalDebt)} –∏–∑ ${fmtShort(initialDebt)}`;
  
  // –°–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤
  const list = document.getElementById('credits-list');
  list.innerHTML = '';
  
  const sorted = [...credits].sort((a, b) => {
    if (a.status.includes('–ó–ê–ú–û–†–û–ñ–ï–ù')) return 1;
    if (b.status.includes('–ó–ê–ú–û–†–û–ñ–ï–ù')) return -1;
    return (b.rate || 0) - (a.rate || 0);
  });
  
  sorted.forEach(c => {
    const balance = c.balanceCurrent || c.balanceInit;
    const isFrozen = c.status.includes('–ó–ê–ú–û–†–û–ñ–ï–ù');
    const paidPct = Math.round((1 - balance / c.balanceInit) * 100);
    const rateStr = c.rate ? (c.rate * 100).toFixed(1) + '%' : '0%';
    
    let priorityBadge = '';
    if (c.priority > 0 && c.priority <= 3 && !isFrozen) {
      priorityBadge = `<span style="background:var(--accent-red); color:white; font-size:9px; padding:2px 6px; border-radius:6px; margin-left:6px;">üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${c.priority}</span>`;
    }
    
    list.innerHTML += `
      <div class="credit-card ${isFrozen ? 'frozen' : ''}">
        <div class="credit-top">
          <div>
            <span class="credit-name">${c.name}</span>
            ${priorityBadge}
          </div>
          <span class="credit-rate">${rateStr}</span>
        </div>
        <div class="credit-amount">${fmt(balance)}</div>
        <div class="credit-row"><span>–ü–ª–∞—Ç—ë–∂ /–º–µ—Å</span><span>${fmt(c.payment)}</span></div>
        ${c.paymentDay ? `<div class="credit-row"><span>–î–µ–Ω—å –ø–ª–∞—Ç–µ–∂–∞</span><span>${c.paymentDay}-–µ —á–∏—Å–ª–æ</span></div>` : ''}
        ${c.closeDate ? `<div class="credit-row"><span>–ó–∞–∫—Ä—ã—Ç–∏–µ (–ø–ª–∞–Ω)</span><span>${c.closeDate}</span></div>` : ''}
        ${isFrozen ? '<div style="text-align:center; font-size:11px; color:#B2BEC3; margin-top:6px;">‚ö†Ô∏è –ó–∞–º–æ—Ä–æ–∂–µ–Ω –¥–æ –∞–ø—Ä–µ–ª—è 2026</div>' : ''}
        <div class="credit-progress">
          <div class="credit-progress-fill" style="width:${Math.max(paidPct, 0)}%;"></div>
        </div>
        <div style="text-align:right; font-size:10px; color:var(--text-secondary); margin-top:2px;">
          –ü–æ–≥–∞—à–µ–Ω–æ ${paidPct}%
        </div>
      </div>`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ï–ù–î–ï–†: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCalculator() {
  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const daysInMonth = new Date(now.getFullYear(), currentMonth, 0).getDate();
  const daysPassed = now.getDate();
  const daysLeft = daysInMonth - daysPassed;
  const monthProgress = daysPassed / daysInMonth;
  
  // –ë–∞–ª–∞–Ω—Å (–∏–∑ –¥–∞–Ω–Ω—ã—Ö)
  const debitBalances = appState.balances.filter(b => b.type === '–î–µ–±–µ—Ç' || b.type === '–†–°—á');
  const totalBalance = debitBalances.reduce((s, b) => s + (b.balance || 0), 0);
  
  // –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–∞ –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫ –º–µ—Å—è—Ü–∞
  const monthForecast = appState.forecast.find(f => f.month === currentMonth) || {};
  const monthIncome = monthForecast.income || 0;
  const remainingIncome = Math.round(monthIncome * (1 - monthProgress));
  
  // –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å–µ–º—å—é (–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫)
  const familyExpenses = appState.settings['—Ä–∞—Å—Ö–æ–¥—ã_—Å–µ–º—å—è'] || 300000;
  const remainingFamily = Math.round(familyExpenses * (1 - monthProgress));
  
  // –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ –º–µ—Å—è—Ü–µ)
  const activeCredits = appState.credits.filter(c => c.status === '–ê–∫—Ç–∏–≤–Ω—ã–π');
  let remainingCredits = 0;
  activeCredits.forEach(c => {
    if (c.paymentDay && c.paymentDay > now.getDate()) {
      remainingCredits += c.payment;
    } else if (!c.paymentDay) {
      // –ï—Å–ª–∏ –¥–µ–Ω—å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
      remainingCredits += Math.round(c.payment * (1 - monthProgress));
    }
  });
  
  // –ê—Ä–µ–Ω–¥–∞
  const rent = appState.settings['–∞—Ä–µ–Ω–¥–∞_–≤—Å–µ–≥–æ'] || 396000;
  // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º –∞—Ä–µ–Ω–¥–∞ –µ—â—ë –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
  const remainingRent = rent;
  
  // –ò—Ç–æ–≥–æ
  const freeAmount = totalBalance + remainingIncome - remainingFamily - remainingCredits - remainingRent;
  
  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
  document.getElementById('calc-free').textContent = fmt(freeAmount);
  
  let statusEmoji, statusText;
  if (freeAmount > 200000) { statusEmoji = 'üü¢'; statusText = '–û—Ç–ª–∏—á–Ω–æ'; }
  else if (freeAmount > 50000) { statusEmoji = 'üü°'; statusText = '–ù–æ—Ä–º–∞–ª—å–Ω–æ'; }
  else if (freeAmount > 0) { statusEmoji = 'üü†'; statusText = '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ'; }
  else { statusEmoji = 'üî¥'; statusText = '–î–µ—Ñ–∏—Ü–∏—Ç'; }
  
  document.getElementById('calc-status').textContent = `${statusEmoji} ${statusText} ‚Ä¢ –î–µ–Ω—å ${daysPassed}/${daysInMonth}`;
  
  document.getElementById('calc-balance').textContent = totalBalance > 0 ? '+' + fmt(totalBalance) : fmt(totalBalance) || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  document.getElementById('calc-income').textContent = '+' + fmt(remainingIncome);
  document.getElementById('calc-family').textContent = '‚àí' + fmt(remainingFamily);
  document.getElementById('calc-credits-pay').textContent = '‚àí' + fmt(remainingCredits);
  document.getElementById('calc-rent').textContent = '‚àí' + fmt(remainingRent);
  
  // –ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏
  renderUpcomingPayments();
}

function renderUpcomingPayments() {
  const now = new Date();
  const today = now.getDate();
  const container = document.getElementById('upcoming-payments');
  
  const upcoming = appState.credits
    .filter(c => c.status === '–ê–∫—Ç–∏–≤–Ω—ã–π' && c.paymentDay > 0)
    .map(c => ({
      name: c.name,
      amount: c.payment,
      day: c.paymentDay,
      daysUntil: c.paymentDay >= today ? c.paymentDay - today : (30 - today + c.paymentDay)
    }))
    .sort((a, b) => a.daysUntil - b.daysUntil)
    .slice(0, 5);
  
  if (upcoming.length === 0) {
    container.innerHTML = '<p style="font-size:13px; color:var(--text-secondary);">–î–Ω–∏ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ —É–∫–∞–∑–∞–Ω—ã. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ Google Sheets.</p>';
    return;
  }
  
  container.innerHTML = upcoming.map(p => `
    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border);">
      <div>
        <div style="font-size:13px; font-weight:600;">${p.name}</div>
        <div style="font-size:11px; color:var(--text-secondary);">${p.day}-–µ —á–∏—Å–ª–æ (—á–µ—Ä–µ–∑ ${p.daysUntil} –¥–Ω.)</div>
      </div>
      <div style="font-size:15px; font-weight:700; color:var(--accent-red);">${fmt(p.amount)}</div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –£–¢–ò–õ–ò–¢–´
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function fmt(num) {
  if (!num && num !== 0) return '‚Äî';
  return new Intl.NumberFormat('ru-RU').format(Math.round(num)) + '‚ÇΩ';
}

function fmtShort(num) {
  if (!num) return '0';
  if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + '–ú‚ÇΩ';
  if (Math.abs(num) >= 1000) return Math.round(num / 1000) + '–ö‚ÇΩ';
  return Math.round(num) + '‚ÇΩ';
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.onload = function() {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  const now = new Date();
  document.getElementById('bizMonthSelect').value = now.getMonth() + 1;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
  loadAllData();
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW reg failed:', err));
  }
};
</script>
</body>
</html>
